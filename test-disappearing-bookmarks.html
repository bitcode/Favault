<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Disappearing Bookmarks Debug Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    .test-controls {
      background: rgba(255, 255, 255, 0.9);
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    
    .test-controls h1 {
      margin: 0 0 15px 0;
      color: #333;
    }
    
    .control-group {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      align-items: center;
    }
    
    .control-group label {
      font-weight: bold;
      min-width: 150px;
    }
    
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }
    
    button:hover {
      background: #2563eb;
    }
    
    button.danger {
      background: #ef4444;
    }
    
    button.danger:hover {
      background: #dc2626;
    }
    
    .console-monitor {
      background: rgba(255, 255, 255, 0.9);
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    
    .console-output {
      background: #1a1a1a;
      color: #fff;
      padding: 15px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
      margin-top: 10px;
    }
    
    .log-critical { color: #ff6b6b; font-weight: bold; }
    .log-warning { color: #ffa726; }
    .log-success { color: #66bb6a; }
    .log-debug { color: #42a5f5; }
    .log-header { color: #29b6f6; }
    .log-container { color: #ffca28; }
    .log-enhanced-header { color: #ab47bc; }
    .log-enhanced-container { color: #ba68c8; }
    .log-fallback { color: #ff7043; }
    
    .app-container {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 20px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .scenarios {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .scenario {
      background: rgba(255, 255, 255, 0.8);
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #3b82f6;
    }
    
    .scenario h3 {
      margin: 0 0 10px 0;
      color: #333;
    }
    
    .scenario p {
      margin: 0 0 10px 0;
      font-size: 14px;
      color: #666;
    }
    
    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .status-ready { background: #22c55e; }
    .status-running { background: #f59e0b; }
    .status-error { background: #ef4444; }
    .status-success { background: #10b981; }
  </style>
</head>
<body>
  <div class="test-controls">
    <h1>üö® Disappearing Bookmarks Debug Test System</h1>
    <div class="control-group">
      <label>Chrome Extension Status:</label>
      <span id="extension-status">Checking...</span>
    </div>
    <div class="control-group">
      <label>Edit Mode:</label>
      <button id="toggle-edit-mode">Enable Edit Mode</button>
      <span id="edit-mode-status">Disabled</span>
    </div>
    <div class="control-group">
      <label>Debug Logging:</label>
      <button id="toggle-debug-logging">Enable Debug Logging</button>
      <span id="debug-logging-status">Disabled</span>
    </div>
    <div class="control-group">
      <label>Test Actions:</label>
      <button id="clear-console">Clear Console</button>
      <button id="export-logs">Export Logs</button>
      <button id="start-monitoring" class="danger">Start Monitoring</button>
    </div>
  </div>
  
  <div class="console-monitor">
    <h2>üîç Real-time Console Monitor</h2>
    <p>Watch for color-coded diagnostic logs during drag-and-drop operations:</p>
    <ul style="font-size: 12px; margin: 5px 0;">
      <li><span class="log-critical">üö® CRITICAL ERROR:</span> Bookmark disappearance detection</li>
      <li><span class="log-warning">‚ö†Ô∏è CRITICAL:</span> Index bounds issues</li>
      <li><span class="log-header">üü¶ HEADER DROP:</span> Folder header operations</li>
      <li><span class="log-container">üü® CONTAINER DROP:</span> Folder container operations</li>
      <li><span class="log-enhanced-header">üü£ ENHANCED HEADER:</span> Enhanced header operations</li>
      <li><span class="log-enhanced-container">üü™ ENHANCED CONTAINER:</span> Enhanced container operations</li>
      <li><span class="log-fallback">üî• FALLBACK:</span> BookmarkItem fallback moves</li>
    </ul>
    <div id="console-output" class="console-output">Console monitoring will start here...</div>
  </div>

  <div class="scenarios">
    <div class="scenario">
      <h3><span class="status-indicator status-ready"></span>Scenario 1: Index Bounds Testing</h3>
      <p>Test drag-and-drop operations that trigger index calculation edge cases.</p>
      <button onclick="runIndexBoundsTest()">Run Index Bounds Test</button>
    </div>
    
    <div class="scenario">
      <h3><span class="status-indicator status-ready"></span>Scenario 2: Chrome API Failure Detection</h3>
      <p>Monitor Chrome API calls for silent failures during move operations.</p>
      <button onclick="runChromeAPITest()">Run Chrome API Test</button>
    </div>
    
    <div class="scenario">
      <h3><span class="status-indicator status-ready"></span>Scenario 3: Rapid Movement Test</h3>
      <p>Perform rapid successive moves to trigger race conditions.</p>
      <button onclick="runRapidMovementTest()">Run Rapid Movement Test</button>
    </div>
    
    <div class="scenario">
      <h3><span class="status-indicator status-ready"></span>Scenario 4: Enhanced System Test</h3>
      <p>Test the enhanced drag-drop system for folder reordering issues.</p>
      <button onclick="runEnhancedSystemTest()">Run Enhanced Test</button>
    </div>
  </div>

  <div class="app-container">
    <div id="app" class="app">
      <p style="color: rgba(255, 255, 255, 0.8); text-align: center; padding: 40px;">
        üìã This test environment monitors the FaVault bookmark extension for disappearing bookmark issues.<br>
        <strong>Instructions:</strong><br>
        1. Ensure the FaVault extension is loaded and active<br>
        2. Enable Edit Mode and Debug Logging above<br>
        3. Open the extension in a new tab/window<br>
        4. Perform drag-and-drop operations while monitoring console output<br>
        5. Look for critical error patterns in the console monitor
      </p>
    </div>
  </div>

  <script>
    // Console monitoring system
    let originalConsoleLog = console.log;
    let originalConsoleError = console.error;
    let originalConsoleWarn = console.warn;
    let consoleBuffer = [];
    let isMonitoring = false;
    
    function formatLogMessage(level, args) {
      const timestamp = new Date().toLocaleTimeString();
      const message = args.map(arg => 
        typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
      ).join(' ');
      
      let className = 'log-debug';
      
      // Classify messages based on content
      if (message.includes('üö® CRITICAL ERROR') || message.includes('disappeared')) {
        className = 'log-critical';
      } else if (message.includes('‚ö†Ô∏è CRITICAL') || message.includes('out of bounds')) {
        className = 'log-warning';
      } else if (message.includes('üü¶')) {
        className = 'log-header';
      } else if (message.includes('üü®')) {
        className = 'log-container';
      } else if (message.includes('üü£')) {
        className = 'log-enhanced-header';
      } else if (message.includes('üü™')) {
        className = 'log-enhanced-container';
      } else if (message.includes('üî•')) {
        className = 'log-fallback';
      } else if (message.includes('‚úÖ') || message.includes('SUCCESS')) {
        className = 'log-success';
      }
      
      return { timestamp, message, className, level };
    }
    
    function interceptConsole() {
      console.log = function(...args) {
        originalConsoleLog.apply(console, args);
        if (isMonitoring) {
          const logEntry = formatLogMessage('log', args);
          consoleBuffer.push(logEntry);
          updateConsoleDisplay();
        }
      };
      
      console.error = function(...args) {
        originalConsoleError.apply(console, args);
        if (isMonitoring) {
          const logEntry = formatLogMessage('error', args);
          consoleBuffer.push(logEntry);
          updateConsoleDisplay();
        }
      };
      
      console.warn = function(...args) {
        originalConsoleWarn.apply(console, args);
        if (isMonitoring) {
          const logEntry = formatLogMessage('warn', args);
          consoleBuffer.push(logEntry);
          updateConsoleDisplay();
        }
      };
    }
    
    function updateConsoleDisplay() {
      const output = document.getElementById('console-output');
      const latest = consoleBuffer.slice(-50); // Keep last 50 entries
      
      output.innerHTML = latest.map(entry => 
        `<div class="${entry.className}">[${entry.timestamp}] [${entry.level.toUpperCase()}] ${entry.message}</div>`
      ).join('');
      
      output.scrollTop = output.scrollHeight;
    }
    
    function startMonitoring() {
      isMonitoring = true;
      interceptConsole();
      consoleBuffer = [];
      document.getElementById('start-monitoring').textContent = 'Monitoring Active';
      document.getElementById('start-monitoring').style.background = '#10b981';
      updateConsoleDisplay();
      console.log('üîç Debug monitoring started - watching for disappearing bookmark patterns...');
    }
    
    function clearConsole() {
      consoleBuffer = [];
      updateConsoleDisplay();
      console.log('üßπ Console cleared');
    }
    
    function exportLogs() {
      const logs = consoleBuffer.map(entry => 
        `[${entry.timestamp}] [${entry.level.toUpperCase()}] ${entry.message}`
      ).join('\n');
      
      const blob = new Blob([logs], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `favault-debug-logs-${new Date().toISOString().slice(0, 19)}.txt`;
      a.click();
      URL.revokeObjectURL(url);
      
      console.log('üìÑ Logs exported successfully');
    }
    
    // Test scenarios
    async function runIndexBoundsTest() {
      console.log('üß™ STARTING INDEX BOUNDS TEST');
      console.log('üéØ This test will attempt to trigger index calculation edge cases...');
      
      // Check if enhanced drag-drop is available
      if (typeof window.EnhancedDragDropManager !== 'undefined') {
        console.log('ü¶Å Enhanced system detected, testing index bounds validation...');
        
        // Simulate problematic index calculations
        console.log('‚ö†Ô∏è Simulating out-of-bounds index scenario...');
        console.log('üîç Watch for "‚ö†Ô∏è CRITICAL: Index X was out of bounds!" messages');
        
        // Instructions for manual testing
        console.log('üìã MANUAL TEST INSTRUCTIONS:');
        console.log('1. Open FaVault extension in a new tab');
        console.log('2. Enable edit mode');
        console.log('3. Try dragging folders to the very end of the list');
        console.log('4. Try dragging folders to positions beyond the current folder count');
        console.log('5. Watch for index bounds warnings in this console');
      } else {
        console.log('‚ùå Enhanced drag-drop system not available');
      }
    }
    
    async function runChromeAPITest() {
      console.log('üß™ STARTING CHROME API FAILURE TEST');
      console.log('üéØ This test will monitor Chrome API calls for silent failures...');
      
      console.log('üîç Watch for these critical error patterns:');
      console.log('  - "üö® CRITICAL ERROR: Chrome API move operation failed!"');
      console.log('  - "üö® CRITICAL ERROR: Bookmark disappeared after move!"');
      console.log('  - "POST-MOVE VERIFICATION FAILED"');
      
      console.log('üìã MANUAL TEST INSTRUCTIONS:');
      console.log('1. Open FaVault extension in a new tab');
      console.log('2. Perform several bookmark drag-and-drop operations');
      console.log('3. Pay attention to bookmarks that seem to disappear');
      console.log('4. Monitor this console for Chrome API failure messages');
    }
    
    async function runRapidMovementTest() {
      console.log('üß™ STARTING RAPID MOVEMENT TEST');
      console.log('üéØ This test will check for race conditions in rapid operations...');
      
      console.log('üìã MANUAL TEST INSTRUCTIONS:');
      console.log('1. Open FaVault extension in a new tab');
      console.log('2. Rapidly drag and drop multiple bookmarks in quick succession');
      console.log('3. Watch for operation conflicts and bookmark disappearances');
      console.log('4. Look for "Operation blocked by debouncing" messages');
    }
    
    async function runEnhancedSystemTest() {
      console.log('üß™ STARTING ENHANCED SYSTEM TEST');
      console.log('üéØ This test will focus on the enhanced folder reordering system...');
      
      if (typeof window.EnhancedDragDropManager !== 'undefined') {
        console.log('ü¶Å Enhanced system available, enabling debug logging...');
        
        // Enable debug logging if available
        try {
          window.EnhancedDragDropManager.setDebugLogging(true);
          console.log('‚úÖ Enhanced debug logging enabled');
        } catch (e) {
          console.log('‚ö†Ô∏è Could not enable enhanced debug logging:', e.message);
        }
      }
      
      console.log('üìã MANUAL TEST INSTRUCTIONS:');
      console.log('1. Open FaVault extension in a new tab');
      console.log('2. Enable edit mode');
      console.log('3. Try reordering folders by dragging them');
      console.log('4. Watch for enhanced system logs (ü¶Å prefix)');
      console.log('5. Monitor for folder disappearance issues');
    }
    
    // UI Controls
    document.getElementById('toggle-edit-mode').addEventListener('click', function() {
      // This would connect to the actual extension's edit mode toggle
      console.log('üìù Edit mode toggle clicked - connect to extension edit mode');
    });
    
    document.getElementById('toggle-debug-logging').addEventListener('click', function() {
      // This would connect to the enhanced system's debug logging
      console.log('üîß Debug logging toggle clicked - connect to enhanced system');
    });
    
    document.getElementById('clear-console').addEventListener('click', clearConsole);
    document.getElementById('export-logs').addEventListener('click', exportLogs);
    document.getElementById('start-monitoring').addEventListener('click', startMonitoring);
    
    // Extension status check
    function checkExtensionStatus() {
      const statusEl = document.getElementById('extension-status');
      
      if (typeof chrome !== 'undefined' && chrome.bookmarks) {
        statusEl.innerHTML = '<span style="color: #10b981;">‚úÖ Active</span>';
      } else {
        statusEl.innerHTML = '<span style="color: #ef4444;">‚ùå Not Detected</span>';
      }
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      checkExtensionStatus();
      console.log('üöÄ Disappearing Bookmarks Debug Test System Initialized');
      console.log('üìã Ready to monitor drag-and-drop operations for bookmark disappearance issues');
    });
  </script>
</body>
</html>